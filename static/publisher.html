<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Publisher</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Publishing Camera → Server</h1>
    <video id="preview" autoplay playsinline muted></video>

<script>
(async () => {
  const vid_prev = document.getElementById("preview");

  // 1. Get local camera
  const stream = await navigator.mediaDevices.getUserMedia({
    // video: { width: { ideal: 1280 }, height: { ideal: 720 } },
    video: true,
    audio: false
  });
  vid_prev.srcObject = stream;

  // 2. Create PeerConnection
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }]
  });

  // 3. Add tracks
  for (const track of stream.getTracks()) {
    pc.addTrack(track, stream);
  }

  // 4. Create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // wait for ICE gathering complete so SDP includes candidates
  await new Promise((resolve) => {
    if (pc.iceGatheringState === "complete") {
      resolve();
    } else {
      pc.addEventListener("icegatheringstatechange", () => {
        if (pc.iceGatheringState === "complete") {
          resolve();
        }
      });
    }
  });

  // 5. Send offer → server
  const res = await fetch("/api/webrtc/publish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      sdp: pc.localDescription.sdp,
      type: pc.localDescription.type,
    }),
  });

  // 6. Apply answer
  const answer = await res.json();
  await pc.setRemoteDescription(answer);

  console.log("Streaming to server…");
})();
</script>
</body>
</html>
